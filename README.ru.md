# Система Регистрации для TeamTalk (Бот)

[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![Репозиторий GitHub](https://img.shields.io/badge/GitHub-Repo-blue.svg)](https://github.com/kirill-jjj/teamtalk_reg_system)

Комплексное решение для самостоятельной регистрации пользователей на серверах TeamTalk 5, включающее интерфейс Telegram-бота и опциональный веб-портал регистрации на базе Flask. Этот проект призван упростить процесс присоединения новых пользователей к сообществам TeamTalk.

## Зачем этот бот?

По умолчанию на сервере TeamTalk только администраторы могут создавать новые учетные записи пользователей. Это может стать узким местом для растущих сообществ или для серверов, где администраторы не всегда доступны. Система Регистрации TeamTalk позволяет пользователям регистрироваться самостоятельно, оптимизируя этот процесс. Этот бот распространяется под лицензией GPLv3, что гарантирует его как свободное программное обеспечение с открытым исходным кодом.

Он позволяет пользователям регистрироваться:
*   Через Telegram-бота, с опциональным шагом подтверждения администратором.
*   Через веб-страницу (на базе Flask), с ограничением регистраций по IP-адресу.

## Возможности

*   **Регистрация через Telegram-бота:**
    *   Дружелюбный процесс регистрации.
    *   Выбор языка (английский/русский).
    *   Опциональное подтверждение новых регистраций администратором.
    *   Автоматическая генерация и отправка файлов подключения `.tt` и ссылок для быстрого подключения.
*   **Веб-регистрация (Flask):**
    *   Опциональная, может быть включена/отключена через конфигурацию.
    *   Выбор языка на веб-странице (английский/русский).
    *   Ограничение регистраций по IP-адресу (в рамках сессии Flask-приложения).
    *   Автоматическая генерация и отправка файлов подключения `.tt` и ссылок для быстрого подключения.
    *   Опционально: Загрузка преднастроенного клиента TeamTalk (ZIP), если предоставлен шаблон.
*   **Конфигурация:**
    *   Простая настройка с использованием файла `.env`.
    *   Настраиваемые данные сервера TeamTalk, ID администраторов, проверка регистрации и т.д.
*   **Локализация:**
    *   Пользовательский интерфейс доступен на английском и русском языках (на основе Gettext `.po` файлов, легко расширяется).
*   **Интеграция с TeamTalk:**
    *   Использует библиотеку `py-talk-ex` для надежного взаимодействия с TeamTalk SDK.
    *   Проверяет существующие имена пользователей на сервере TeamTalk.
    *   Оповещает администраторов на сервере TeamTalk о новых регистрациях.
*   **База данных:**
    *   База данных SQLite (через SQLAlchemy и aiosqlite) для отслеживания регистраций пользователей Telegram и предотвращения создания нескольких учетных записей с одного Telegram ID.

## Установка

Данные инструкции предполагают, что у вас установлен Python 3.11+.

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/kirill-jjj/teamtalk_reg_system.git
    cd teamtalk_reg_system
    ```

2.  **Установите `uv`**

    Если у вас не установлен `uv` (быстрый установщик и разрешитель пакетов Python), вы можете установить его следующим образом:

    *   **Для Linux и macOS:**
        ```bash
        curl -LsSf https://astral.sh/uv/install.sh | sh
        # После установки может потребоваться перезагрузить конфигурацию оболочки или открыть новый терминал.
        # Либо выполните команду, предложенную установщиком, часто это:
        source $HOME/.local/bin/env
        ```
    *   **Для Windows:**
        Самый простой способ, если у вас установлен Python и pip:
        ```bash
        pip install uv
        ```
        Другие способы установки (например, через установщик) можно найти в [официальной документации Astral `uv`](https://astral.sh/uv).

    Убедитесь, что `uv` доступен в вашем PATH. Вы можете проверить это, выполнив команду `uv --version`.

3.  **Установите зависимости и настройте окружение с помощью `uv`:**
    Эта команда создаст виртуальное окружение (если оно еще не существует) в папке `.venv` внутри каталога вашего проекта и установит все зависимости из `requirements.txt`.
    ```bash
    uv sync
    ```

4.  **Скомпилируйте файлы локализации**

    Этот проект использует Babel для интернационализации. Чтобы все текстовые строки корректно отображались на поддерживаемых языках (английском и русском), необходимо скомпилировать файлы локализации.

    Активируйте ваше виртуальное окружение, если `uv sync` не сделал это для текущей сессии (например, `source .venv/bin/activate` для Linux/macOS или `.\.venv\Scripts\activate` для Windows). Затем выполните следующую команду из корневого каталога проекта:
    ```bash
    pybabel compile -D messages -d locales
    ```
    Эта команда скомпилирует файлы `.po` в файлы `.mo`, которые используются приложением.

    *(Опционально) Если вы вносите изменения в переводимые строки в коде Python или шаблонах Jinja2, вам потребуется обновить файлы перевода:*
    1.  *Извлеките сообщения для обновления файла шаблона `.pot`:*
        ```bash
        pybabel extract -F babel.cfg -o locales/messages.pot .
        ```
    2.  *Обновите файлы `.po` для конкретных языков (например, для русского):*
        ```bash
        pybabel update -i locales/messages.pot -d locales -l ru
        ```
    *После обновления файлов `.po` с переводами, снова выполните команду `compile`.*

5.  **Настройте бота:**
    *   Переименуйте файл `.env.example` в `.env`.
    *   Откройте файл `.env` в текстовом редакторе и укажите ваши данные (список необходимых полей и их описание см. в `.env.example`). Ключевые настройки:
        *   `TG_BOT_TOKEN`: Токен вашего Telegram-бота.
        *   `ADMIN_IDS`: Telegram User ID администраторов бота.
        *   Данные для подключения к серверу TeamTalk (`HOST_NAME`, `PORT`, `USER_NAME`, `PASSWORD`).
        *   Настройки веб-регистрации Flask (если включена).
        *   **Важно:** Измените `FLASK_SECRET_KEY` на надежное, случайное значение, если используете веб-регистрацию.

6.  **Запустите бота с помощью `uv`:**
    Эта команда запустит скрипт `run.py` внутри виртуального окружения, управляемого `uv`.
    ```bash
    uv run python run.py
    ```
    *(Для Linux/macOS, если `run.py` имеет shebang и является исполняемым, команда `uv run ./run.py` также может сработать, но `uv run python run.py` более универсальна).*

## Использование

*   **Telegram Бот:** Начните чат с вашим ботом и отправьте команду `/start`.
*   **Веб-регистрация:** Если включена, перейдите по адресу `http://<FLASK_HOST>:<FLASK_PORT>/register` (или вашему настроенному URL) в веб-браузере.

## Примечание о вкладе ИИ

Обратите внимание, что примерно 60% кодовой базы этого проекта было создано с помощью Искусственного Интеллекта. Хотя код, по-видимому, функционирует корректно и в целом без ошибок, вы можете столкнуться с:

*   Комментариями в коде, которые выглядят как заглушки или заметки от ИИ (например, `# это оставлено здесь`).
*   Участками кода, которые могут быть не такими удобочитаемыми или не в полной мере соответствовать общепринятым лучшим практикам, как код, полностью написанный человеком-разработчиком.

Мы приветствуем вклад в улучшение ясности и поддерживаемости кода.

## Благодарности

Этот проект был бы невозможен без вклада и вдохновения следующих людей и проектов:

*   **[BlindMaster24](https://github.com/BlindMaster24):** За написание примерно 70% этого бота, включая первоначальную структуру и добавление веб-регистрации. Его работа над `py-talk-ex` также является основополагающей для этого проекта.
*   **[gumerov-amir](https://github.com/gumerov-amir) и [m1maker](https://github.com/m1maker):** За их неоценимую помощь в исправлении критической ошибки, связанной с форматированием файлов `.tt`, что обеспечило совместимость с различными версиями клиента TeamTalk.

А также всему сообществу открытого исходного кода за библиотеки и инструменты, которые делают возможными подобные проекты.

## Участие в проекте

Мы приветствуем любой вклад! Вы можете сделать форк репозитория, внести свои изменения и отправить pull request. Если вы обнаружите ошибки или у вас есть предложения по новым функциям, пожалуйста, создайте issue на [странице Issues в GitHub](https://github.com/kirill-jjj/teamtalk_reg_system/issues).

## Лицензия

Этот проект лицензирован на условиях GNU General Public License v3.0 - подробности см. в файле [LICENSE](LICENSE).