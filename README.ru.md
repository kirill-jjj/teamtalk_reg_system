# Система Регистрации для TeamTalk (Бот)

[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
[![Репозиторий GitHub](https://img.shields.io/badge/GitHub-Repo-blue.svg)](https://github.com/kirill-jjj/teamtalk_reg_system)

Комплексное решение для самостоятельной регистрации пользователей на серверах TeamTalk 5, включающее интерфейс Telegram-бота и опциональный веб-портал регистрации на базе Flask. Этот проект призван упростить процесс присоединения новых пользователей к сообществам TeamTalk.

## Зачем этот бот?

По умолчанию на сервере TeamTalk только администраторы могут создавать новые учетные записи пользователей. Это может стать узким местом для растущих сообществ или для серверов, где администраторы не всегда доступны. Система Регистрации TeamTalk позволяет пользователям регистрироваться самостоятельно, оптимизируя этот процесс. Этот бот распространяется под лицензией GPLv3, что гарантирует его как свободное программное обеспечение с открытым исходным кодом.

Он позволяет пользователям регистрироваться:
*   Через Telegram-бота, с опциональным шагом подтверждения администратором.
*   Через веб-страницу (на базе FastAPI), с ограничением регистраций по IP-адресу.

## Возможности

*   **Регистрация через Telegram-бота:**
    *   Дружелюбный процесс регистрации.
    *   Выбор языка (английский/русский).
    *   Опциональное подтверждение новых регистраций администратором.
    *   Автоматическая генерация и отправка файлов подключения `.tt` и ссылок для быстрого подключения.
*   **Веб-регистрация (FastAPI):**
    *   Опциональная, может быть включена/отключена через конфигурацию (`WEB_REGISTRATION_ENABLED`).
    *   Выбор языка на веб-странице (английский/русский).
    *   Ограничение регистраций по IP-адресу.
    *   Автоматическая генерация и отправка файлов подключения `.tt` и ссылок для быстрого подключения.
    *   Опционально: Загрузка преднастроенного клиента TeamTalk (ZIP), если предоставлен шаблон.
*   **Конфигурация:**
    *   Простая настройка с использованием файла `.env`.
    *   Настраиваемые данные сервера TeamTalk, ID администраторов, проверка регистрации и т.д.
*   **Локализация:**
    *   Пользовательский интерфейс доступен на английском и русском языках (на основе Gettext `.po` файлов, легко расширяется).
*   **Интеграция с TeamTalk:**
    *   Использует библиотеку `py-talk-ex` для надежного взаимодействия с TeamTalk SDK.
    *   Проверяет существующие имена пользователей на сервере TeamTalk.
    *   Оповещает администраторов на сервере TeamTalk о новых регистрациях.
*   **База данных:**
    *   База данных SQLite (через SQLAlchemy и aiosqlite) для отслеживания регистраций пользователей Telegram и предотвращения создания нескольких учетных записей с одного Telegram ID.

## Установка

Данные инструкции предполагают, что у вас установлен Python 3.11+.

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/kirill-jjj/teamtalk_reg_system.git
    cd teamtalk_reg_system
    ```

2.  **Установите `uv`**

    Если у вас не установлен `uv` (быстрый установщик и разрешитель пакетов Python), вы можете установить его следующим образом:

    *   **Для Linux и macOS:**
        ```bash
        curl -LsSf https://astral.sh/uv/install.sh | sh
        # После установки может потребоваться перезагрузить конфигурацию оболочки или открыть новый терминал.
        # Либо выполните команду, предложенную установщиком, часто это:
        source $HOME/.local/bin/env
        ```
    *   **Для Windows:**
        Самый простой способ, если у вас установлен Python и pip:
        ```bash
        pip install uv
        ```
        Другие способы установки (например, через установщик) можно найти в [официальной документации Astral `uv`](https://astral.sh/uv).

    Убедитесь, что `uv` доступен в вашем PATH. Вы можете проверить это, выполнив команду `uv --version`.

3.  **Установите зависимости и настройте окружение с помощью `uv`:**
    Эта команда создаст виртуальное окружение (например, в папке `.venv`), если оно не существует, а затем синхронизирует окружение с зависимостями, указанными в `pyproject.toml` (и, возможно, `uv.lock`, если он присутствует).
    ```bash
    uv sync
    ```

4.  **Скомпилируйте файлы локализации**

    Этот проект использует Babel для интернационализации. Чтобы все текстовые строки корректно отображались на поддерживаемых языках (английском и русском), необходимо скомпилировать файлы локализации.

    выполните следующую команду из корневого каталога проекта:
    ```bash
    uv run pybabel compile -D messages -d locales
    ```
    Эта команда скомпилирует файлы `.po` в файлы `.mo`, которые используются приложением.

    *(Опционально) Если вы вносите изменения в переводимые строки в коде Python или шаблонах Jinja2, вам потребуется обновить файлы перевода:*
    1.  *Извлеките сообщения для обновления файла шаблона `.pot`:*
        ```bash
        uv run pybabel extract -F babel.cfg -o locales/messages.pot .
        ```
    2.  *Обновите файлы `.po` для конкретных языков (например, для русского):*
        ```bash
        uv run pybabel update -i locales/messages.pot -d locales -l ru
        ```
    *После обновления файлов `.po` с переводами, снова выполните команду `compile`.*

5.  **Настройте бота:**
    *   Переименуйте файл `.env.example` в `.env`.
    *   Откройте файл `.env` в текстовом редакторе и укажите ваши данные (список необходимых полей и их описание см. в `.env.example`). Ключевые настройки:
        *   `TG_BOT_TOKEN`: Токен вашего Telegram-бота.
        *   `ADMIN_IDS`: Telegram User ID администраторов бота.
        *   Данные для подключения к серверу TeamTalk (`HOST_NAME`, `PORT`, `USER_NAME`, `PASSWORD`).
        *   Настройки веб-регистрации (если включена, используя переменные `WEB_APP_HOST`, `WEB_APP_PORT`, которые теперь используются Uvicorn).
        *   `FLASK_SECRET_KEY` (теперь удален/закомментирован в `.env.example`) больше не используется FastAPI для управления сессиями напрямую так, как это было в Flask. Если будет добавлена собственная логика сессий/cookie в FastAPI, следует обеспечить безопасные практики.
        *   **Новые переменные конфигурации (опционально):**
            *   `TT_PUBLIC_HOSTNAME`: Публичное имя хоста, которое будет использоваться в генерируемых .tt файлах и ссылках. Если не указано, используется `HOST_NAME`. (Опционально)
            *   `TT_JOIN_CHANNEL`: Идентификатор канала (целое число) или путь к каналу (строка, например, «/» для корневого канала или «/Мой канал/Подканал»), к которому бот будет подключаться при запуске. Если не указано, бот не будет автоматически подключаться к каналу. (Опционально)
            *   `TT_JOIN_CHANNEL_PASSWORD`: Пароль для канала, указанного в `TT_JOIN_CHANNEL`. (Опционально, если канал без пароля)
            *   `TT_STATUS_TEXT`: Статусное сообщение для бота в TeamTalk. (Опционально, по умолчанию пусто)
            *   `TT_GENDER`: Пол бота в TeamTalk. Возможные значения: `male`, `female`, `neutral`. По умолчанию `neutral`. (Опционально)

6.  **Запустите приложение с помощью `uv`:**
    Эта команда запустит скрипт `run.py` внутри виртуального окружения, управляемого `uv`. `run.py` теперь запускает и Telegram-бота, и веб-приложение FastAPI (с использованием Uvicorn).
    ```bash
    uv run python run.py
    ```
    Веб-приложение FastAPI будет доступно по хосту и порту, указанным в вашем файле `.env` (например, `http://127.0.0.1:5000`).

## Использование

*   **Telegram Бот:** Начните чат с вашим ботом и отправьте команду `/start`.
*   **Веб-регистрация:** Если включена (`WEB_REGISTRATION_ENABLED=true` в `.env`), перейдите по адресу `http://<ваш_хост>:<ваш_порт>/register` (например, `http://127.0.0.1:5000/register`) в веб-браузере. Хост и порт определяются переменными `WEB_APP_HOST` и `WEB_APP_PORT` в вашем файле `.env`.

## Управление локализацией

Этот проект использует Babel для локализации. Скрипт `manage-locales.py` (находится в корне проекта) помогает управлять файлами локализации.

Скрипт предоставляет следующие команды:

*   `uv run manage-locales.py extract`: Извлекает переводимые строки из исходного кода в шаблонный файл `.pot` (`locales/messages.pot`).

*   `uv run manage-locales.py update`: Обновляет языковые файлы `.po` (например, `locales/ru/LC_MESSAGES/messages.po`) из шаблонного файла `.pot`.

*   `uv run manage-locales.py compile`: Компилирует файлы `.po` в бинарные файлы `.mo`, используемые приложением. Этот шаг необходим после обновления файлов `.po`. Шаг "Скомпилируйте файлы локализации" во время первоначальной установки уже выполняет это.

*   `uv run manage-locales` (или `uv run manage-locales.py all`): Выполняет все три шага: извлечение, обновление и компиляцию.

*   `uv run manage-locales.py help`: Показывает справочную информацию.

## Примечание

Обратите внимание, что примерно 60% кодовой базы этого проекта было создано с помощью Искусственного Интеллекта. Хотя код, по-видимому, функционирует корректно и в целом без ошибок, вы можете столкнуться с:

*   Комментариями в коде, которые выглядят как заглушки или заметки от ИИ (например, `# это оставлено здесь`).
*   Участками кода, которые могут быть не такими удобочитаемыми или не в полной мере соответствовать общепринятым лучшим практикам, как код, полностью написанный человеком-разработчиком.

Мы приветствуем вклад в улучшение ясности и поддерживаемости кода.

## Благодарности

Этот проект был бы невозможен без вклада и вдохновения следующих людей и проектов:

*   **[BlindMaster24](https://github.com/BlindMaster24):** За написание примерно 70% этого бота, включая первоначальную структуру и добавление веб-регистрации. Его работа над `py-talk-ex` также является основополагающей для этого проекта.
*   **[gumerov-amir](https://github.com/gumerov-amir) и [m1maker](https://github.com/m1maker):** За их неоценимую помощь в исправлении критической ошибки, связанной с форматированием файлов `.tt`, что обеспечило совместимость с различными версиями клиента TeamTalk.

А также всему сообществу открытого исходного кода за библиотеки и инструменты, которые делают возможными подобные проекты.

## Участие в проекте

Мы приветствуем любой вклад! Вы можете сделать форк репозитория, внести свои изменения и отправить pull request. Если вы обнаружите ошибки или у вас есть предложения по новым функциям, пожалуйста, создайте issue на [странице Issues в GitHub](https://github.com/kirill-jjj/teamtalk_reg_system/issues).

## Лицензия

Этот проект лицензирован на условиях GNU General Public License v3.0 - подробности см. в файле [LICENSE](LICENSE).